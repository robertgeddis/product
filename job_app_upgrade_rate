--- NOTE: A seeker can have more than one job, how do we deal with that when measuring upgrade conversion metrics? 

select 
  jobs_apps.country,
  jobs_apps.vertical,
  jobs_apps.seeker,
  jobs_apps.job,
  jobs_apps.job_post_date,
  jobs_apps.job_post_method,
  jobs_apps.app_provider,
  jobs_apps.app,
  jobs_apps.app_sent_date,
  jobs_apps.app_type,
  case when subscription_id is not null and jobs_apps.job_post_date > upgrades.upgrade_date then 'Upgraded Before Job Post' 
       when subscription_id is not null and jobs_apps.job_post_date < upgrades.upgrade_date then 'Upgraded After Job Post'
    else null end as job_upgrade_status, 
  case when subscription_id is not null and jobs_apps.app_sent_date > upgrades.upgrade_date then 'Upgraded Before First App' 
       when subscription_id is not null and jobs_apps.app_sent_date < upgrades.upgrade_date then 'Upgraded After First App'
    else null end as app_upgrade_status,
  datediff(hh,jobs_apps.job_post_date,jobs_apps.app_sent_date) as hours_job_post_app,
  upgrades.subscription_id,
  upgrades.upgrade_date 
from
  (select 
      upper(jb.country_code) as country,
      initcap(jb.vertical_id) as vertical,
      jb.member_id as seeker,
      jb.id as job,
      jb.date_created as job_post_date,
      jb.posting_method as job_post_method,
      ja.member_id as app_provider,
      ja.id as app,
      ja.date_created as app_sent_date,
      case when ja.was_sent_automatically = 'false' then 'Manual' else 'Auto' end as app_type
    from intl.job jb
    left join intl.job_application ja on jb.id = ja.job_id and jb.country_code = ja.country_code 
          and jb.date_created < ja.date_created 
    where jb.search_status = 'Approved'
      and year(jb.date_created) >= 2021
      and date(jb.date_created) < date(current_date)) jobs_apps
    
left join 
(select
    upper(mm.countrycode) as country,
    mm.memberid as seeker,
    sp.subscriptionid as subscription_id,
    sp.subscriptionDateCreated as upgrade_date 
  from intl.transaction tt
  join intl.hive_subscription_plan sp on sp.subscriptionId = tt.subscription_plan_id 
            and sp.countrycode = tt.country_code and year(sp.subscriptionDateCreated) >= 2021 
            and date(sp.subscriptionDateCreated) < date(current_date)
  join intl.hive_member mm on tt.member_id = mm.memberid and tt.country_code = mm.countrycode
            and mm.IsInternalAccount = 'false' and lower(mm.role) = 'seeker'    
  where tt.type in ('PriorAuthCapture','AuthAndCapture')
    and tt.status = 'SUCCESS'
    and tt.amount > 0) upgrades on jobs_apps.seeker = upgrades.seeker and jobs_apps.country = upgrades.country 
                                      and date(upgrade_date) >= date(jobs_apps.job_post_date)
                                  
where jobs_apps.seeker in ('1908314', '1234459')
