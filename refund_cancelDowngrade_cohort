select memberid, pricePlanFee, discounted_fee, billed_service_start_date, subscriptionid, subscriptionDateCreated, transaction_date, firstPaymentDate, nextPaymentDate
from
(select 
  sp.memberid,
  dn.pricePlanFee, 
  dn.discounted_fee,
  dn.billed_service_start_date,    
  dn.subscriptionid, 
  tt.date_created as transaction_date,
  sp.subscriptionDateCreated,   
  sp.firstPaymentDate, 
  dn.nextPaymentDate,
  rank () over (partition by sp.memberid order by tt.date_created asc) as ranked_transaction_date 
from intl.transaction tt
join intl.hive_subscription_plan sp on tt.member_id = sp.memberid and tt.country_code = sp.countrycode and tt.subscription_plan_id = sp.subscriptionid
join (select billed_service_start_date, memberid, subscriptionid, countrycode, subscriptionDateCreated, nextPaymentDate, pricePlanDurationInMonths, pricePlanFee, discounted_fee
            from
              (select billed_service_start_date, memberid, subscriptionid, countrycode, subscriptionDateCreated, nextPaymentDate, 
                      pricePlanDurationInMonths, pricePlanFee, discounted_fee,
                      rank() over (partition by memberid order by billed_service_start_date desc) as ranked_bill_date
                from (select distinct   
                        --case when tt.type = 'AuthAndCapture' then tt.billed_service_start_date else null end as billed_service_start_date,
                        tt.billed_service_start_date, 
                        sp.memberid, 
                        sp.subscriptionid, 
                        sp.countrycode, 
                        sp.subscriptionDateCreated, 
                        sp.nextPaymentDate, 
                        sp.pricePlanDurationInMonths,
                        sp.pricePlanFee,
                        (sp.pricePlanFee*0.7) as discounted_fee
                      from intl.transaction tt
                        join intl.hive_subscription_plan sp on tt.member_id = sp.memberid and tt.country_code = sp.countrycode and tt.subscription_plan_id = sp.subscriptionid
                      where tt.type in ('PriorAuthCapture','AuthAndCapture')
                        and tt.status = 'SUCCESS'
                        and tt.amount > 0
                        and sp.promotionCode = 'canceldowngrade30'
                        and sp.nextPaymentDateAction = 'Downgrade'
                        and date(sp.subscriptionDateCreated) >= '2022-03-01'
                        and date(sp.subscriptionDateCreated) < date(current_date)
                        and sp.countrycode not in ('uk','ca','au','nz','ch')
                        and sp.pricePlanDurationInMonths <> 1) ab
                ) cd
            where ranked_bill_date = 1
          ) dn on dn.memberid = sp.memberid and dn.countrycode = sp.countrycode and dn.subscriptionDateCreated > sp.subscriptionDateCreated
where tt.type in ('PriorAuthCapture','AuthAndCapture') 
  and tt.status = 'SUCCESS'
  and tt.amount > 0
  and date(sp.subscriptionDateCreated) >= '2022-03-01'
  and date(sp.subscriptionDateCreated) < date(current_date)
  and sp.countrycode not in ('uk','ca','au','nz','ch')
  and sp.pricePlanDurationInMonths <> 1
  and sp.nextPaymentDateAction = 'ApplyPromotion'
group by 1,2,3,4,5,6,7,8,9
) comb
where ranked_transaction_date = 1
