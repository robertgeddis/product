select 
  dd.year, dd.date, 
  count(distinct sp.memberid) as EOP_Premiums,
  count(distinct case when mm.memberstatus = 'PendingActive' then sp.memberid end) as EOP_Pending
     
from intl.transaction tt
  join intl.hive_subscription_plan sp on sp.subscriptionId = tt.subscription_plan_id and sp.countrycode = tt.country_code 
  join intl.hive_member mm            on tt.member_id = mm.memberid and tt.country_code = mm.countrycode and mm.IsInternalAccount = 'false' and mm.closedforfraud = 'false' and lower(mm.role) = 'seeker' 
  join reporting.dw_d_date dd         on date(sp.subscriptionEndDate) > dd.date 

where tt.type in ('PriorAuthCapture','AuthAndCapture')
  and tt.status = 'SUCCESS'
  and tt.amount > 0
  and dd.date < date(current_date)

group by 1,2 
